<svg width="900" height="2200" xmlns="http://www.w3.org/2000/svg">

<style>
    text { font-family: Arial, sans-serif; font-size: 18px; }
    .title { font-size: 28px; font-weight: bold; }
    .node { font-size: 18px; }
    .sub { font-size: 16px; }
    .line { stroke: #333; stroke-width: 1.5; }
</style>

<!-- TITLE -->
<text x="20" y="40" class="title">Webpack Module Federation - Runtime 全流程（树状结构）</text>

<!-- MAIN ROOT -->
<text x="40" y="110" class="node">Module Federation Runtime Flow</text>
<line x1="50" y1="120" x2="50" y2="2100" class="line"></line>

<!-- 1. Init -->
<text x="120" y="180" class="node">1. __webpack_init_sharing__()</text>
<line x1="50" y1="180" x2="110" y2="180" class="line"></line>
<text x="160" y="220" class="sub">• 初始化全局共享作用域（shareScope）</text>
<text x="160" y="255" class="sub">• 检查远程与本地版本</text>
<text x="160" y="290" class="sub">• 选择更高兼容版本</text>

<!-- 2. Load Remote -->
<text x="120" y="360" class="node">2. remote container 加载</text>
<line x1="50" y1="360" x2="110" y2="360" class="line"></line>
<text x="160" y="400" class="sub">• script 标签加载 remoteEntry.js</text>
<text x="160" y="435" class="sub">• remote 将自己注册进全局 registry</text>
<text x="160" y="470" class="sub">• 调用 remote.init(shareScope)</text>

<!-- 3. get() -->
<text x="120" y="540" class="node">3. remote.get(module)</text>
<line x1="50" y1="540" x2="110" y2="540" class="line"></line>
<text x="160" y="580" class="sub">• remote 内部查表 modules[moduleId]</text>
<text x="160" y="615" class="sub">• 如果是 shared module → 执行版本比较</text>
<text x="160" y="650" class="sub">• 返回工厂函数 factory()</text>

<!-- 4. Load Chunk -->
<text x="120" y="720" class="node">4. 触发 host chunk 加载</text>
<line x1="50" y1="720" x2="110" y2="720" class="line"></line>
<text x="160" y="760" class="sub">• __webpack_require__.e(chunkId)</text>
<text x="160" y="795" class="sub">• JSONP 异步加载 chunk.js</text>
<text x="160" y="830" class="sub">• chunk 回调 webpackJsonpCallback()</text>

<!-- 5. Execute factory -->
<text x="120" y="900" class="node">5. 执行工厂函数 factory()</text>
<line x1="50" y1="900" x2="110" y2="900" class="line"></line>
<text x="160" y="940" class="sub">• 构建模块 exports 对象</text>
<text x="160" y="975" class="sub">• 调用依赖（可能跨容器）</text>
<text x="160" y="1010" class="sub">• 返回实例化模块</text>

<!-- 6. Shared Module logic -->
<text x="120" y="1080" class="node">6. Shared Module 版本决策</text>
<line x1="50" y1="1080" x2="110" y2="1080" class="line"></line>
<text x="160" y="1120" class="sub">• requiredVersion vs availableVersion</text>
<text x="160" y="1155" class="sub">• semver 范围检查</text>
<text x="160" y="1190" class="sub">• 可选策略：highest / singleton / strict</text>
<text x="160" y="1225" class="sub">• 返回最终选用的共享模块</text>

<!-- 7. Final -->
<text x="120" y="1290" class="node">7. 最终导出</text>
<line x1="50" y1="1290" x2="110" y2="1290" class="line"></line>
<text x="160" y="1330" class="sub">• host 得到 remote 提供的模块</text>
<text x="160" y="1365" class="sub">• 可与本地模块混编运行</text>

<!-- Dev Tools -->
<text x="120" y="1450" class="node">补充：开发/调试关键点</text>
<line x1="50" y1="1450" x2="110" y2="1450" class="line"></line>
<text x="160" y="1490" class="sub">• remoteEntry 必须可访问（CORS）</text>
<text x="160" y="1525" class="sub">• shared React 必须选 singleton</text>
<text x="160" y="1560" class="sub">• dev server 需允许跨域</text>

<!-- Files -->
<text x="120" y="1640" class="node">核心源码文件（对应流程）</text>
<line x1="50" y1="1640" x2="110" y2="1640" class="line"></line>
<text x="160" y="1680" class="sub">• container/ContainerEntryModule</text>
<text x="160" y="1715" class="sub">• container/ContainerReferencePlugin</text>
<text x="160" y="1750" class="sub">• container/RemoteRuntimeModule.js</text>
<text x="160" y="1785" class="sub">• sharing/ProvideSharedPlugin</text>
<text x="160" y="1820" class="sub">• sharing/ConsumeSharedPlugin</text>

<!-- END -->
</svg>
