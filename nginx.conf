# 企业级解决方案配置
server {
  listen 80;
  server_name _;

  root /www/wwwroot;

  # remoteEntry not cached
  location ~* /microfrontend/.*/remoteEntry\.js$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires 0;
    add_header Access-Control-Allow-Origin *;   # only if cross-origin remotes are used
    try_files $uri =404;
  }

  # hashed assets long cache
  location ~* /microfrontend/.*/assets/.*\.(?:js|css|png|jpg|jpeg|gif|svg|woff2?|ttf)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # index.html (short cache)
  location ~* /microfrontend/.*/index\.html$ {
    add_header Cache-Control "no-cache";
    try_files $uri =404;
  }

  location ~ ^/microfrontend/(main|shop|utils|components)$ {
    return 301 $uri/;
  }

  # fallback for SPA routes
  location /microfrontend/ {
    try_files $uri $uri/ /microfrontend/main/index.html; # or per app fallback
  }
}





# 基础版本配置
# server {
#     listen 80;
#     server_name _;

#     # ===========================
#     # Main 应用
#     # ===========================
#     location /microfrontend/main/ {
#         alias /www/wwwroot/microfrontend/main/;

#         # 静态资源
#         location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
#             expires 30d;
#             add_header Cache-Control "public, max-age=2592000";
#             try_files $uri =404;
#         }

#         # SPA fallback
#         try_files $uri $uri/ /microfrontend/main/index.html;
#         expires 7d;
#         add_header Cache-Control "public, max-age=604800";
#     }

#     location = /microfrontend/main {
#         return 301 /microfrontend/main/;
#     }

#     # ===========================
#     # Shop 应用
#     # ===========================
#     location /microfrontend/shop/ {
#         alias /www/wwwroot/microfrontend/shop/;

#         location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
#             expires 30d;
#             add_header Cache-Control "public, max-age=2592000";
#             try_files $uri =404;
#         }

#         try_files $uri $uri/ /microfrontend/shop/index.html;
#         expires 7d;
#         add_header Cache-Control "public, max-age=604800";
#     }

#     # 处理缺少斜杠的访问，重定向到带斜杠的路径
#     location = /microfrontend/shop {
#         return 301 /microfrontend/shop/;
#     }
#     #   另一种写法
#     # location ~ ^/microfrontend/shop(/.*)?$ {
#     #     alias /www/wwwroot/microfrontend/shop$1;
#     #     try_files $uri $uri/ /microfrontend/shop/index.html;
#     # }


#     # ===========================
#     # Utils 应用
#     # ===========================
#     location /microfrontend/utils/ {
#         alias /www/wwwroot/microfrontend/utils/;

#         location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
#             expires 30d;
#             add_header Cache-Control "public, max-age=2592000";
#             try_files $uri =404;
#         }

#         try_files $uri $uri/ /microfrontend/utils/index.html;
#         expires 7d;
#         add_header Cache-Control "public, max-age=604800";
#     }

#     # 模块联邦入口文件 没有hash 所以禁止缓存
#     location = /microfrontend/utils/utilsEntry.js {
#         alias /www/wwwroot/microfrontend/utils/utilsEntry.js;
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         add_header Access-Control-Allow-Origin *;
#         expires off;
#     }

#     # ===========================
#     # Components 应用
#     # ===========================
#     location /microfrontend/components/ {
#         alias /www/wwwroot/microfrontend/components/;

#         location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
#             expires 30d;
#             add_header Cache-Control "public, max-age=2592000";
#             try_files $uri =404;
#         }

#         try_files $uri $uri/ /microfrontend/components/index.html;
#         expires 7d;
#         add_header Cache-Control "public, max-age=604800";
#     }

#     location = /microfrontend/components/componentsEntry.js {
#         alias /www/wwwroot/microfrontend/components/componentsEntry.js;
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         add_header Access-Control-Allow-Origin *;
#         expires off;
#     }
# }
