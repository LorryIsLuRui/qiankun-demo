server {
    listen 80;
    server_name _;

    # ===========================
    # Main 应用
    # ===========================
    location /microfrontend/main/ {
        alias /www/wwwroot/microfrontend/main/;

        # 静态资源
        location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            try_files $uri =404;
        }

        # SPA fallback
        try_files $uri $uri/ /microfrontend/main/index.html;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # 强制 remoteEntry.js 不缓存
    location = /microfrontend/main/remoteEntry.js {
        alias /www/wwwroot/microfrontend/main/remoteEntry.js;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }


    # ===========================
    # Shop 应用
    # ===========================
    location /microfrontend/shop/ {
        alias /www/wwwroot/microfrontend/shop/;

        location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            try_files $uri =404;
        }

        try_files $uri $uri/ /microfrontend/shop/index.html;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    location = /microfrontend/shop/remoteEntry.js {
        alias /www/wwwroot/microfrontend/shop/remoteEntry.js;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }


    # ===========================
    # Utils 应用
    # ===========================
    location /microfrontend/utils/ {
        alias /www/wwwroot/microfrontend/utils/;

        location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            try_files $uri =404;
        }

        try_files $uri $uri/ /microfrontend/utils/index.html;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    location = /microfrontend/utils/remoteEntry.js {
        alias /www/wwwroot/microfrontend/utils/remoteEntry.js;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }


    # ===========================
    # Components 应用
    # ===========================
    location /microfrontend/components/ {
        alias /www/wwwroot/microfrontend/components/;

        location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            try_files $uri =404;
        }

        try_files $uri $uri/ /microfrontend/components/index.html;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    location = /microfrontend/components/remoteEntry.js {
        alias /www/wwwroot/microfrontend/components/remoteEntry.js;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }
}
