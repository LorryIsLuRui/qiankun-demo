name: Deploy

on:
  push:
    branches:
      - main

jobs:
  # #########################################################
  # 1. æ£€æµ‹å“ªäº› package å‘ç”Ÿå˜åŒ–
  # #########################################################
  detect:
    runs-on: ubuntu-latest
    outputs:
      main_changed: ${{ steps.diff.outputs.main }}
      shop_changed: ${{ steps.diff.outputs.shop }}
      utils_changed: ${{ steps.diff.outputs.utils }}
      components_changed: ${{ steps.diff.outputs.components }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changed packages
        id: diff
        run: |
          echo "main=$(git diff --name-only HEAD^ HEAD | grep '^packages/main/' | wc -l)" >> $GITHUB_OUTPUT
          echo "shop=$(git diff --name-only HEAD^ HEAD | grep '^packages/shop/' | wc -l)" >> $GITHUB_OUTPUT
          echo "utils=$(git diff --name-only HEAD^ HEAD | grep '^packages/utils/' | wc -l)" >> $GITHUB_OUTPUT
          echo "components=$(git diff --name-only HEAD^ HEAD | grep '^packages/components/' | wc -l)" >> $GITHUB_OUTPUT

          echo "==== Changed Result ===="
          echo "main: $(grep '^packages/main/' -c <<< $(git diff --name-only HEAD^ HEAD))"
          echo "shop: $(grep '^packages/shop/' -c <<< $(git diff --name-only HEAD^ HEAD))"
          echo "utils: $(grep '^packages/utils/' -c <<< $(git diff --name-only HEAD^ HEAD))"
          echo "components: $(grep '^packages/components/' -c <<< $(git diff --name-only HEAD^ HEAD))"


  # #########################################################
  # 2. ç¼–è¯‘ & éƒ¨ç½²ï¼ˆmatrix æŒ‰éœ€æ‰§è¡Œï¼‰
  # #########################################################
  build_and_deploy:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: [main, shop, utils, components]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      # ---------------- SSH é…ç½® ----------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      # ---------------- BUILD ----------------
      - name: Build changed package
        if: |
          (matrix.package == 'main' && needs.detect.outputs.main_changed != '0') ||
          (matrix.package == 'shop' && needs.detect.outputs.shop_changed != '0') ||
          (matrix.package == 'utils' && needs.detect.outputs.utils_changed != '0') ||
          (matrix.package == 'components' && needs.detect.outputs.components_changed != '0')
        run: npm run build --workspace=packages/${{ matrix.package }}

      # ---------------- DEPLOYï¼ˆrsyncï¼‰ ----------------
      - name: Deploy to server
        if: |
          (matrix.package == 'main' && needs.detect.outputs.main_changed != '0') ||
          (matrix.package == 'shop' && needs.detect.outputs.shop_changed != '0') ||
          (matrix.package == 'utils' && needs.detect.outputs.utils_changed != '0') ||
          (matrix.package == 'components' && needs.detect.outputs.components_changed != '0')
        run: |
          echo "Deploying ${{ matrix.package }} ..."
          rsync -avz --delete \
            packages/${{ matrix.package }}/dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{secrets.REMOTE_BASE}}/${{ matrix.package }}/

      - name: Deployment complete
        if: |
          (matrix.package == 'main' && needs.detect.outputs.main_changed != '0') ||
          (matrix.package == 'shop' && needs.detect.outputs.shop_changed != '0') ||
          (matrix.package == 'utils' && needs.detect.outputs.utils_changed != '0') ||
          (matrix.package == 'components' && needs.detect.outputs.components_changed != '0')
        run: echo "ðŸš€ Finished deploying ${{ matrix.package }}"


# ä¸æ£€æµ‹å˜æ›´åº”ç”¨ ç›´æŽ¥å…¨é‡éƒ¨ç½²
# name: Deploy Microfrontend

# on:
#   push:
#     branches: ["main"]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Install Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install deps
#         run: npm install

#       - name: Build all apps
#         run: |
#           npm run build

#       - name: Setup SSH
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa

#       - name: Check key format
#         run: |
#           echo "Lines in id_rsa:"
#           wc -l ~/.ssh/id_rsa
#           head -n 5 ~/.ssh/id_rsa

#       - name: Add server to known_hosts
#         run: ssh-keyscan -H 82.157.148.39 >> ~/.ssh/known_hosts
      
#       - name: Deploy to Server
#         run: |
#           rsync -avz packages/main/dist/        root@82.157.148.39:/www/wwwroot/microfrontend/main/
#           rsync -avz packages/shop/dist/        root@82.157.148.39:/www/wwwroot/microfrontend/shop/
#           rsync -avz packages/utils/dist/       root@82.157.148.39:/www/wwwroot/microfrontend/utils/
#           rsync -avz packages/components/dist/  root@82.157.148.39:/www/wwwroot/microfrontend/components/
        
#       - name: Restart Nginx
#         run: |
#           ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "nginx -s reload"
